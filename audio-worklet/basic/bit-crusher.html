<!DOCTYPE html>
<html>
<head>
  <title>AudioWorklet BitCrusher | Chrome WebAudio Samples</title>
  <link rel="stylesheet" href="../../resources/base.css">
  <script src="../lib/audio-worklet-base.js"></script>
</head>
<body>
  <a href="../index.html" class="link-small">&#171; AudioWorklet home</a>
  <h1>Demo: BitCrusher</h1>
  <script>
    // Global GC hack...
    let paramBitDepth;
    let paramReduction;

    function runDemo() {
      const context = new AudioContext();
      let oscillator = new OscillatorNode(context);
      let bitCrusher = new AudioWorkletNode(context, 'bit-crusher');
      oscillator.connect(bitCrusher).connect(context.destination);
      
      paramBitDepth = bitCrusher.parameters.get('bitDepth');
      paramReduction = bitCrusher.parameters.get('frequencyReduction');
      
      paramBitDepth.setValueAtTime(1, 0);
      paramReduction.setValueAtTime(0.01, 0);
      paramReduction.linearRampToValueAtTime(0.1, 4);
      paramReduction.exponentialRampToValueAtTime(0.01, 8);
      paramReduction.setValueAtTime(0.01, 8.01);

      oscillator.start();
    }
    
    window.addEventListener('load', () => {
      LibAudioWorklet.initializeReporter();
      if (LibAudioWorklet.isAvailable()) {
        LibAudioWorklet.reportMessage('info',
            'AudioWorklet is available. Start running demo...');
        window.audioWorklet.addModule('js/bit-crusher.js').then(runDemo);
      } else {
        LibAudioWorklet.reportMessage('error',
            'The browser does not support AudioWorklet yet.');
      }
    });
  </script>
</body>
</html>
